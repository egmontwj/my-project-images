<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ResearchGlobe by Wang Jin</title>

  <script src="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

  <style>
    /* All your existing CSS goes here... */
    html, body, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }
    .info-panel { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(40, 40, 40, 0.8); color: white; padding: 10px 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1000; text-align: center; }
    .info-panel h1 { margin: 0; font-size: 2em; color: white; }
    .ui-panel { background: rgba(40, 40, 40, 0.8); color: white; padding: 10px 15px; border-radius: 8px; z-index: 1000; font-size: 13px; }
    .panel-title { font-size: 16px; font-weight: bold; margin-top: 0; margin-bottom: 10px; }
    #layer-panel { position: absolute; top: 95px; left: 20px; width: 350px; }
    #layer-panel h4 { margin-top: 0; margin-bottom: 10px; }
    #layer-panel ul { list-style: none; margin: 0; padding-left: 15px; }
    #layer-panel li { margin-bottom: 5px; }
    #layer-panel label { vertical-align: middle; padding-left: 5px; }
    #layer-panel .citation { margin-top: 10px; font-size: 11px; font-style: italic; }
    #layer-panel .citation a { color: #93c5fd; text-decoration: none; }
    #layer-panel .citation a:hover { text-decoration: underline; }
    #legend-panel { position: absolute; bottom: 40px; left: 20px; display: none; }
    #legend-panel.visible { display: block; }
    .legend-subtitle { font-size: 12px; font-style: italic; text-align: center; margin: -8px 0 8px 0; }
    .legend-gradient { width: 150px; height: 20px; background: linear-gradient(to right, #0000FF, #FFFF00, #FFA500, #FF0000); border-radius: 3px; }
    .legend-labels { display: flex; justify-content: space-between; font-size: 12px; padding-top: 3px; }
    #data-panel { position: absolute; top: 95px; right: 20px; text-align: center; }
    #data-panel #coords-value { min-width: 180px; display: inline-block; }
    #contact-panel { position: absolute; bottom: 40px; right: 20px; }
    #contact-panel p { margin: 5px 0; }
    #contact-panel a { color: #93c5fd; text-decoration: none; }
    #contact-panel a:hover { text-decoration: underline; }
    hr { border-color: rgba(128, 128, 128, 0.5); margin: 15px 0; }
  </style>
</head>
<body>

<div id="cesiumContainer"></div>
<div class="info-panel">
  <h1>ResearchGlobe by Wang Jin</h1>
</div>

<div id="layer-panel" class="ui-panel">
  <h3 class="panel-title">Layer Control</h3>
  <h4>Kernel density map of geotagged post (2021)</h4>
  <ul>
    <li>
      <input type="checkbox" id="shenzhen-poi-checkbox" checked>
      <label for="shenzhen-poi-checkbox">Shenzhen, China</label>
    </li>
    <li>
      <input type="checkbox" id="chicago-poi-checkbox" checked>
      <label for="chicago-poi-checkbox">Chicago, USA</label>
    </li>
    <li class="citation">
      Citation: <a href="https://www.sciencedirect.com/science/article/pii/S1569843225001852" target="_blank" rel="noopener noreferrer">Improving subpixel impervious surface estimation...</a>
    </li>
  </ul>
  <hr> 
  <h4>Impervious Density</h4>
  <ul>
    <li>
      <input type="checkbox" id="sz-cart-checkbox">
      <label for="sz-cart-checkbox">Shenzhen Impervious Density by CART</label>
    </li>
    <li>
      <input type="checkbox" id="chicago-cart-checkbox">
      <label for="chicago-cart-checkbox">Chicago Impervious Density by CART</label>
    </li>
  </ul>
</div>

<div id="legend-panel" class="ui-panel">
  <h3 class="panel-title">Legend</h3>
  <h4 class="legend-subtitle">POI Kernel Density</h4>
  <div class="legend-gradient"></div>
  <div class="legend-labels">
    <span>0</span>
    <span>13000</span>
  </div>
</div>

<div id="data-panel" class="ui-panel">
  <h3 class="panel-title">Value by Click</h3>
  <span id="coords-value">Click on the map</span><br>
  Value: <span id="attribute-value">N/A</span>
</div>

<div id="contact-panel" class="ui-panel">
  <h3 class="panel-title">Contact Info</h3>
  <p><strong><a href="http://globalchange.msu.edu/directory/wang-jin-bio.html" target="_blank" rel="noopener noreferrer">Dr. Wang Jin</a></strong></p>
  <p><a href="https://scholar.google.com/citations?user=ogvm4OsAAAAJ&hl=en" target="_blank" rel="noopener noreferrer">Google Scholar</a></p>
  <p>Michigan State University</p>
  <p>wangj329@msu.edu</p>
</div>

<script>
  let viewer;
  // --- Initialize Cesium Viewer ---
  try {
    viewer = new Cesium.Viewer('cesiumContainer', {
      imageryProvider: new Cesium.OpenStreetMapImageryProvider({ url : 'https://a.tile.openstreetmap.org/' }),
      animation: false, timeline: false, geocoder: false, homeButton: false, sceneModePicker: false, baseLayerPicker: false, navigationHelpButton: false,
    });
  } catch (error) { console.error("ERROR creating viewer:", error); }

  if (viewer) {
    // --- POI Kernel Density Layers (Raster) ---
    const poiShenzhenLayer = viewer.imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({ url: `https://storage.googleapis.com/myearth-465423-bucket/shenzhen_tiles/{z}/{x}/{y}.png`, maximumLevel: 13 }));
    const poiChicagoLayer = viewer.imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({ url: `https://storage.googleapis.com/myearth-465423-bucket/chicago_tiles/{z}/{x}/{y}.png`, maximumLevel: 13 }));
    poiShenzhenLayer.alpha = 0.7;
    poiChicagoLayer.alpha = 0.7;

    // --- Helper function to style vector polygons ---
    function styleVectorLayer(dataSource, propertyName) {
      return dataSource.loadPromise.then(() => {
        const entities = dataSource.entities.values;
        for (let i = 0; i < entities.length; i++) {
          const entity = entities[i];
          const impValue = entity.properties[propertyName] ? entity.properties[propertyName].getValue() : 0;
          const colorValue = impValue / 10000.0;
          entity.polygon.material = Cesium.Color.fromHsl(0.6 - colorValue * 0.6, 1.0, 0.5, 0.7);
          entity.polygon.outline = false;
        }
      });
    }

    // --- Helper function to load a split GeoJSON layer ---
    function loadSplitLayer(namePrefix, propertyName) {
        const dataSources = [];
        for (let i = 1; i <= 4; i++) {
            const dataSource = new Cesium.GeoJsonDataSource();
            dataSource.load(`${namePrefix}_Part${i}.geojson`).then(() => styleVectorLayer(dataSource, propertyName));
            dataSource.show = false;
            viewer.dataSources.add(dataSource);
            dataSources.push(dataSource);
        }
        return dataSources;
    }

    const shenzhenCartSources = loadSplitLayer('Imp_Shenzhen_CART', 'ImpPOI10k');
    const chicagoCartSources = loadSplitLayer('Imp_Chicago_CART', 'Imp1w');
    
    // --- Layer Control Logic ---
    function setupCheckbox(checkboxId, layers, flyToLocation) {
        const checkbox = document.getElementById(checkboxId);
        checkbox.addEventListener('change', function(event) {
            const isVisible = event.target.checked;
            layers.forEach(layer => layer.show = isVisible);
            if (isVisible && flyToLocation) {
                viewer.flyTo(layers[0]);
            }
        });
    }
    
    const shenzhenLocation = Cesium.Cartesian3.fromDegrees(114.0577, 22.5431, 200000);
    const chicagoLocation = Cesium.Cartesian3.fromDegrees(-87.6298, 41.8781, 200000);

    setupCheckbox('shenzhen-poi-checkbox', [poiShenzhenLayer], shenzhenLocation);
    setupCheckbox('chicago-poi-checkbox', [poiChicagoLayer], chicagoLocation);
    setupCheckbox('sz-cart-checkbox', shenzhenCartSources, shenzhenLocation);
    setupCheckbox('chicago-cart-checkbox', chicagoCartSources, chicagoLocation);

    // --- Legend and Click Handler ---
    const legendPanel = document.getElementById('legend-panel');
    function updateLegendVisibility() {
        const poiCheckbox1 = document.getElementById('shenzhen-poi-checkbox');
        const poiCheckbox2 = document.getElementById('chicago-poi-checkbox');
        legendPanel.style.display = (poiCheckbox1.checked || poiCheckbox2.checked) ? 'block' : 'none';
    }
    updateLegendVisibility();
    
    document.getElementById('shenzhen-poi-checkbox').addEventListener('change', updateLegendVisibility);
    document.getElementById('chicago-poi-checkbox').addEventListener('change', updateLegendVisibility);

    viewer.screenSpaceEventHandler.setInputAction(function(movement) {
        const coordsSpan = document.getElementById('coords-value');
        const attributeSpan = document.getElementById('attribute-value');
        
        let valueFound = false;
        const pickedObject = viewer.scene.pick(movement.position);
        if (Cesium.defined(pickedObject) && Cesium.defined(pickedObject.id)) {
            const props = pickedObject.id.properties;
            let value = 'N/A';
            if (props.Imp1w) { value = props.Imp1w.getValue(); }
            else if (props.ImpPOI10k) { value = props.ImpPOI10k.getValue(); }
            
            if (value !== 'N/A') {
                attributeSpan.textContent = (value / 10000.0).toFixed(4);
                valueFound = true;
            }
        }
        
        if (!valueFound) {
            attributeSpan.textContent = 'N/A';
        }

        const cartesian = viewer.camera.pickEllipsoid(movement.position, viewer.scene.globe.ellipsoid);
        if (cartesian) {
            const cartographic = Cesium.Cartographic.fromCartesian(cartesian);
            const lon = Cesium.Math.toDegrees(cartographic.longitude).toFixed(5);
            const lat = Cesium.Math.toDegrees(cartographic.latitude).toFixed(5);
            coordsSpan.textContent = `Lat: ${lat}, Lon: ${lon}`;
        } else {
            coordsSpan.textContent = 'No position on globe';
        }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    // --- Initial Camera Flight ---
    const initialCameraFlight = viewer.scene.postRender.addEventListener(function() {
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(114.3, 30.6, 3500000),
        orientation: { heading: Cesium.Math.toRadians(0.0), pitch: Cesium.Math.toRadians(-90.0), roll: 0.0 }
      });
      initialCameraFlight();
    });
  }
</script>

</body>
</html>
